/**
 * ÂØºËà™Ê†èËÆ§ËØÅÁä∂ÊÄÅÁÆ°ÁêÜ
 * Â§ÑÁêÜ‰∏ªÈ°µÂØºËà™Ê†è‰∏≠ÁöÑÁî®Êà∑ËÆ§ËØÅÁä∂ÊÄÅÊòæÁ§∫„ÄÅ‰∏ªÈ¢òÂàáÊç¢ÂíåÁî®Êà∑‰∫§‰∫í
 * ‰∏éFirebase AuthÈõÜÊàêÔºåÊèê‰æõÂÆûÊó∂ÁöÑÁî®Êà∑Áä∂ÊÄÅÊõ¥Êñ∞
 */

class NavbarAuthManager {
    constructor() {
        this.authManager = null;
        this.currentUser = null;
        this.isInitialized = false;
        
        // DOMÂÖÉÁ¥†ÂºïÁî®
        this.elements = {
            themeToggle: null,
            authGuest: null,
            authUser: null,
            userAvatar: null,
            userDropdown: null,
            userDropdownMenu: null,
            userName: null,
            userInfoName: null,
            userInfoEmail: null,
            userInfoAvatar: null,
            userInfoAvatarPlaceholder: null,
            logoutBtn: null
        };
        
        this.init();
    }
    
    /**
     * ÂàùÂßãÂåñÂØºËà™Ê†èËÆ§ËØÅÁÆ°ÁêÜÂô®
     */
    async init() {
        try {
            await this.waitForFirebase();
            await this.initializeElements();
            await this.initializeAuth();
            this.bindEvents();
            this.initializeTheme();
            this.isInitialized = true;
            // console.log('üéâ ÂØºËà™Ê†èËÆ§ËØÅÁÆ°ÁêÜÂô®ÂàùÂßãÂåñÊàêÂäü');
        } catch (error) {
            // console.error('‚ùå ÂØºËà™Ê†èËÆ§ËØÅÁÆ°ÁêÜÂô®ÂàùÂßãÂåñÂ§±Ë¥•:', error);
        }
    }
    
    /**
     * Á≠âÂæÖFirebaseÂä†ËΩΩÂÆåÊàê
     */
    async waitForFirebase() {
        return new Promise((resolve, reject) => {
            let attempts = 0;
            const maxAttempts = 50;
            
            const checkFirebase = () => {
                attempts++;
                
                if (window.firebase && window.firebase.auth) {
                    resolve();
                } else if (attempts >= maxAttempts) {
                    reject(new Error('FirebaseÂä†ËΩΩË∂ÖÊó∂'));
                } else {
                    setTimeout(checkFirebase, 100);
                }
            };
            
            checkFirebase();
        });
    }
    
    /**
     * ÂàùÂßãÂåñDOMÂÖÉÁ¥†ÂºïÁî®
     */
    async initializeElements() {
        // Á≠âÂæÖDOMÂä†ËΩΩÂÆåÊàê
        if (document.readyState === 'loading') {
            await new Promise(resolve => {
                document.addEventListener('DOMContentLoaded', resolve);
            });
        }
        
        // Ëé∑ÂèñDOMÂÖÉÁ¥†
        this.elements.themeToggle = document.getElementById('theme-toggle');
        this.elements.authGuest = document.querySelector('.auth-guest');
        this.elements.authUser = document.querySelector('.auth-user');
        this.elements.userAvatar = document.querySelector('.user-avatar');
        this.elements.userDropdown = document.querySelector('.user-dropdown');
        this.elements.userDropdownMenu = document.querySelector('.user-dropdown-menu');
        this.elements.userName = document.querySelector('.user-name');
        this.elements.userInfoName = document.querySelector('.user-info-name');
        this.elements.userInfoEmail = document.querySelector('.user-info-email');
        this.elements.userInfoAvatar = document.querySelector('.user-info-avatar img');
        this.elements.userInfoAvatarPlaceholder = document.querySelector('.user-info-avatar-placeholder');
        this.elements.logoutBtn = document.querySelector('.logout-btn');
        
        // È™åËØÅÂÖ≥ÈîÆÂÖÉÁ¥†ÊòØÂê¶Â≠òÂú®
        if (!this.elements.themeToggle) {
            // console.warn('‚ö†Ô∏è ‰∏ªÈ¢òÂàáÊç¢ÊåâÈíÆÊú™ÊâæÂà∞');
        }
        
        if (!this.elements.authGuest || !this.elements.authUser) {
            // console.warn('‚ö†Ô∏è ËÆ§ËØÅÂå∫ÂüüÂÖÉÁ¥†Êú™ÊâæÂà∞');
        }
    }
    
    /**
     * ÂàùÂßãÂåñËÆ§ËØÅÁÆ°ÁêÜÂô®
     */
    async initializeAuth() {
        try {
            // Á≠âÂæÖAuthManagerÂä†ËΩΩ
            if (typeof window.authManager !== 'undefined') {
                this.authManager = window.authManager;
                
                // ÁõëÂê¨ËÆ§ËØÅÁä∂ÊÄÅÂèòÂåñ
                this.authManager.addAuthStateListener((user) => {
                    this.handleAuthStateChange(user);
                });
                
                // console.log('‚úÖ ËÆ§ËØÅÁÆ°ÁêÜÂô®ÂàùÂßãÂåñÊàêÂäü');
            } else {
                // console.warn('‚ö†Ô∏è AuthManagerÊú™Âä†ËΩΩÔºåÂ∞ÜÂú®Á®çÂêéÈáçËØï');
                // Âª∂ËøüÈáçËØï
                setTimeout(() => this.initializeAuth(), 1000);
            }
        } catch (error) {
            // console.error('‚ùå ËÆ§ËØÅÁÆ°ÁêÜÂô®ÂàùÂßãÂåñÂ§±Ë¥•:', error);
        }
    }
    
    /**
     * ÁªëÂÆö‰∫ã‰ª∂ÁõëÂê¨Âô®
     */
    bindEvents() {
        // ‰∏ªÈ¢òÂàáÊç¢ÊåâÈíÆ
        if (this.elements.themeToggle) {
            this.elements.themeToggle.addEventListener('click', () => {
                this.toggleTheme();
            });
        }
        
        // Áî®Êà∑Â§¥ÂÉè‰∏ãÊãâËèúÂçï
        if (this.elements.userAvatar) {
            this.elements.userAvatar.addEventListener('click', (e) => {
                e.stopPropagation();
                this.toggleUserDropdown();
            });
        }
        
        // ÈÄÄÂá∫ÁôªÂΩïÊåâÈíÆ
        if (this.elements.logoutBtn) {
            this.elements.logoutBtn.addEventListener('click', async (e) => {
                e.preventDefault();
                await this.handleLogout();
            });
        }
        
        // ÁÇπÂáªÂ§ñÈÉ®ÂÖ≥Èó≠‰∏ãÊãâËèúÂçï
        document.addEventListener('click', (e) => {
            if (this.elements.userDropdown && 
                !this.elements.userDropdown.contains(e.target)) {
                this.closeUserDropdown();
            }
        });
        
        // ESCÈîÆÂÖ≥Èó≠‰∏ãÊãâËèúÂçï
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                this.closeUserDropdown();
            }
        });
    }
    
    /**
     * ÂàùÂßãÂåñ‰∏ªÈ¢ò
     */
    initializeTheme() {
        // ‰ªélocalStorageËé∑Âèñ‰øùÂ≠òÁöÑ‰∏ªÈ¢ò
        const savedTheme = localStorage.getItem('theme');
        const systemTheme = window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
        const currentTheme = savedTheme || systemTheme;
        
        this.setTheme(currentTheme);
        
        // ÁõëÂê¨Á≥ªÁªü‰∏ªÈ¢òÂèòÂåñ
        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', (e) => {
            if (!localStorage.getItem('theme')) {
                this.setTheme(e.matches ? 'dark' : 'light');
            }
        });
    }
    
    /**
     * Â§ÑÁêÜËÆ§ËØÅÁä∂ÊÄÅÂèòÂåñ
     */
    handleAuthStateChange(user) {
        this.currentUser = user;
        
        if (user) {
            this.showUserState(user);
        } else {
            this.showGuestState();
        }
    }
    
    /**
     * ÊòæÁ§∫Â∑≤ÁôªÂΩïÁî®Êà∑Áä∂ÊÄÅ
     */
    showUserState(user) {
        if (!this.elements.authGuest || !this.elements.authUser) return;
        
        // ÈöêËóèÊ∏∏ÂÆ¢Áä∂ÊÄÅÔºåÊòæÁ§∫Áî®Êà∑Áä∂ÊÄÅ
        this.elements.authGuest.style.display = 'none';
        this.elements.authUser.style.display = 'block';
        
        // Êõ¥Êñ∞Áî®Êà∑‰ø°ÊÅØ
        this.updateUserInfo(user);
        
        // console.log('üë§ Áî®Êà∑Â∑≤ÁôªÂΩï:', user.email);
    }
    
    /**
     * ÊòæÁ§∫Ê∏∏ÂÆ¢Áä∂ÊÄÅ
     */
    showGuestState() {
        if (!this.elements.authGuest || !this.elements.authUser) return;
        
        // ÊòæÁ§∫Ê∏∏ÂÆ¢Áä∂ÊÄÅÔºåÈöêËóèÁî®Êà∑Áä∂ÊÄÅ
        this.elements.authGuest.style.display = 'block';
        this.elements.authUser.style.display = 'none';
        
        // ÂÖ≥Èó≠‰∏ãÊãâËèúÂçï
        this.closeUserDropdown();
        
        // console.log('üëã Áî®Êà∑Â∑≤ÈÄÄÂá∫ÁôªÂΩï');
    }
    
    /**
     * Êõ¥Êñ∞Áî®Êà∑‰ø°ÊÅØÊòæÁ§∫
     */
    updateUserInfo(user) {
        const displayName = user.displayName || user.email?.split('@')[0] || 'Áî®Êà∑';
        const email = user.email || '';
        const photoURL = user.photoURL;
        
        // Êõ¥Êñ∞ÂØºËà™Ê†èÁî®Êà∑Âêç
        if (this.elements.userName) {
            this.elements.userName.textContent = displayName;
        }
        
        // Êõ¥Êñ∞‰∏ãÊãâËèúÂçï‰∏≠ÁöÑÁî®Êà∑‰ø°ÊÅØ
        if (this.elements.userInfoName) {
            this.elements.userInfoName.textContent = displayName;
        }
        
        if (this.elements.userInfoEmail) {
            this.elements.userInfoEmail.textContent = email;
        }
        
        // Êõ¥Êñ∞Â§¥ÂÉè
        this.updateUserAvatar(displayName, photoURL);
    }
    
    /**
     * Êõ¥Êñ∞Áî®Êà∑Â§¥ÂÉè
     */
    updateUserAvatar(displayName, photoURL) {
        const avatarElements = [
            document.querySelector('.user-avatar-placeholder'),
            document.querySelector('.user-info-avatar-placeholder')
        ];
        
        const imgElements = [
            document.querySelector('.user-avatar img'),
            document.querySelector('.user-info-avatar img')
        ];
        
        if (photoURL) {
            // ÊòæÁ§∫Áî®Êà∑Â§¥ÂÉèÂõæÁâá
            imgElements.forEach(img => {
                if (img) {
                    img.src = photoURL;
                    img.style.display = 'block';
                }
            });
            
            avatarElements.forEach(placeholder => {
                if (placeholder) {
                    placeholder.style.display = 'none';
                }
            });
        } else {
            // ÊòæÁ§∫Áî®Êà∑ÂêçÈ¶ñÂ≠óÊØç
            const initial = displayName.charAt(0).toUpperCase();
            
            avatarElements.forEach(placeholder => {
                if (placeholder) {
                    placeholder.textContent = initial;
                    placeholder.style.display = 'flex';
                }
            });
            
            imgElements.forEach(img => {
                if (img) {
                    img.style.display = 'none';
                }
            });
        }
    }
    
    /**
     * ÂàáÊç¢‰∏ªÈ¢ò
     */
    toggleTheme() {
        const currentTheme = document.documentElement.getAttribute('data-theme');
        const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
        this.setTheme(newTheme);
    }
    
    /**
     * ËÆæÁΩÆ‰∏ªÈ¢ò
     */
    setTheme(theme) {
        document.documentElement.setAttribute('data-theme', theme);
        localStorage.setItem('theme', theme);
        
        // Êõ¥Êñ∞‰∏ªÈ¢òÂàáÊç¢ÊåâÈíÆÁöÑaria-label
        if (this.elements.themeToggle) {
            const label = theme === 'dark' ? 'ÂàáÊç¢Âà∞‰∫ÆËâ≤‰∏ªÈ¢ò' : 'ÂàáÊç¢Âà∞ÊöóËâ≤‰∏ªÈ¢ò';
            this.elements.themeToggle.setAttribute('aria-label', label);
        }
        
        // // console.log(`üé® ‰∏ªÈ¢òÂ∑≤ÂàáÊç¢Âà∞: ${theme}`);
    }
    
    /**
     * ÂàáÊç¢Áî®Êà∑‰∏ãÊãâËèúÂçï
     */
    toggleUserDropdown() {
        if (!this.elements.userDropdown) return;
        
        const isActive = this.elements.userDropdown.classList.contains('active');
        
        if (isActive) {
            this.closeUserDropdown();
        } else {
            this.openUserDropdown();
        }
    }
    
    /**
     * ÊâìÂºÄÁî®Êà∑‰∏ãÊãâËèúÂçï
     */
    openUserDropdown() {
        if (!this.elements.userDropdown) return;
        
        this.elements.userDropdown.classList.add('active');
        
        // ËÆæÁΩÆÁÑ¶ÁÇπÂà∞Á¨¨‰∏Ä‰∏™ËèúÂçïÈ°π
        const firstItem = this.elements.userDropdownMenu?.querySelector('.dropdown-item');
        if (firstItem) {
            setTimeout(() => firstItem.focus(), 100);
        }
    }
    
    /**
     * ÂÖ≥Èó≠Áî®Êà∑‰∏ãÊãâËèúÂçï
     */
    closeUserDropdown() {
        if (!this.elements.userDropdown) return;
        
        this.elements.userDropdown.classList.remove('active');
    }
    
    /**
     * Â§ÑÁêÜÈÄÄÂá∫ÁôªÂΩï
     */
    async handleLogout() {
        if (!this.authManager) {
            // console.error('‚ùå ËÆ§ËØÅÁÆ°ÁêÜÂô®Êú™ÂàùÂßãÂåñ');
            return;
        }
        
        try {
            // ÊòæÁ§∫Âä†ËΩΩÁä∂ÊÄÅ
            if (this.elements.logoutBtn) {
                this.elements.logoutBtn.classList.add('auth-loading');
                this.elements.logoutBtn.disabled = true;
            }
            
            // ÊâßË°åÈÄÄÂá∫ÁôªÂΩï
            await this.authManager.logout();
            
            // ÂÖ≥Èó≠‰∏ãÊãâËèúÂçï
            this.closeUserDropdown();
            
            // // console.log('üëã Áî®Êà∑Â∑≤ÊàêÂäüÈÄÄÂá∫ÁôªÂΩï');
            
        } catch (error) {
            // console.error('‚ùå ÈÄÄÂá∫ÁôªÂΩïÂ§±Ë¥•:', error);
            
            // ÊòæÁ§∫ÈîôËØØÊèêÁ§∫
            this.showMessage('ÈÄÄÂá∫ÁôªÂΩïÂ§±Ë¥•ÔºåËØ∑ÈáçËØï', 'error');
            
        } finally {
            // ÊÅ¢Â§çÊåâÈíÆÁä∂ÊÄÅ
            if (this.elements.logoutBtn) {
                this.elements.logoutBtn.classList.remove('auth-loading');
                this.elements.logoutBtn.disabled = false;
            }
        }
    }
    
    /**
     * ÊòæÁ§∫Ê∂àÊÅØÊèêÁ§∫
     */
    showMessage(message, type = 'info') {
        // ÂàõÂª∫Ê∂àÊÅØÂÖÉÁ¥†
        const messageEl = document.createElement('div');
        messageEl.className = `message message-${type}`;
        messageEl.textContent = message;
        
        // Ê∑ªÂä†Ê†∑Âºè
        Object.assign(messageEl.style, {
            position: 'fixed',
            top: '20px',
            right: '20px',
            padding: '12px 20px',
            borderRadius: '8px',
            color: 'white',
            fontWeight: '500',
            zIndex: '10000',
            transform: 'translateX(100%)',
            transition: 'transform 0.3s ease-out',
            backgroundColor: type === 'error' ? '#ef4444' : '#10b981'
        });
        
        // Ê∑ªÂä†Âà∞È°µÈù¢
        document.body.appendChild(messageEl);
        
        // ÊòæÁ§∫Âä®Áîª
        setTimeout(() => {
            messageEl.style.transform = 'translateX(0)';
        }, 100);
        
        // Ëá™Âä®ÁßªÈô§
        setTimeout(() => {
            messageEl.style.transform = 'translateX(100%)';
            setTimeout(() => {
                if (messageEl.parentNode) {
                    messageEl.parentNode.removeChild(messageEl);
                }
            }, 300);
        }, 3000);
    }
    
    /**
     * Ëé∑ÂèñÂΩìÂâçÁî®Êà∑
     */
    getCurrentUser() {
        return this.currentUser;
    }
    
    /**
     * Ê£ÄÊü•ÊòØÂê¶Â∑≤ÁôªÂΩï
     */
    isLoggedIn() {
        return !!this.currentUser;
    }
    
    /**
     * ÈîÄÊØÅÁÆ°ÁêÜÂô®
     */
    destroy() {
        // ÁßªÈô§‰∫ã‰ª∂ÁõëÂê¨Âô®
        if (this.elements.themeToggle) {
            this.elements.themeToggle.removeEventListener('click', this.toggleTheme);
        }
        
        if (this.elements.userAvatar) {
            this.elements.userAvatar.removeEventListener('click', this.toggleUserDropdown);
        }
        
        if (this.elements.logoutBtn) {
            this.elements.logoutBtn.removeEventListener('click', this.handleLogout);
        }
        
        // Ê∏ÖÁêÜÂºïÁî®
        this.authManager = null;
        this.currentUser = null;
        this.elements = {};
        this.isInitialized = false;
        
        // // console.log('üßπ ÂØºËà™Ê†èËÆ§ËØÅÁÆ°ÁêÜÂô®Â∑≤ÈîÄÊØÅ');
    }
}

// ÂÖ®Â±ÄÂÆû‰æã
let navbarAuthManager = null;

// È°µÈù¢Âä†ËΩΩÂÆåÊàêÂêéÂàùÂßãÂåñ
if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', () => {
        navbarAuthManager = new NavbarAuthManager();
    });
} else {
    navbarAuthManager = new NavbarAuthManager();
}

// ÂØºÂá∫Âà∞ÂÖ®Â±Ä‰ΩúÁî®Âüü
window.NavbarAuthManager = NavbarAuthManager;
window.navbarAuthManager = navbarAuthManager;

// È°µÈù¢Âç∏ËΩΩÊó∂Ê∏ÖÁêÜ
window.addEventListener('beforeunload', () => {
    if (navbarAuthManager) {
        navbarAuthManager.destroy();
    }
});